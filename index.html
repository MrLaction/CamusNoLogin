<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Video Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{
      font-family:system-ui;
      max-width:900px;
      margin:24px auto;
      padding:12px;
      background:#0a0a0a;
      color:#e5e5e5;
    }
    .header{
      text-align:center;
      margin-bottom:32px;
    }
    .header h1{
      font-size:28px;
      margin-bottom:8px;
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .header p{color:#8e8e8e;font-size:14px}
    .status-badge{
      display:inline-block;
      padding:4px 12px;
      border-radius:12px;
      font-size:12px;
      margin-top:8px;
      background:#1a3a1a;
      color:#5dd55d;
      border:1px solid #2a5a2a;
    }
    .row{display:flex;gap:8px;margin-bottom:16px}
    input{
      flex:1;
      padding:14px;
      border-radius:10px;
      border:1px solid #333;
      background:#1a1a1a;
      color:#e5e5e5;
      font-size:14px;
      transition:border 0.3s;
    }
    input:focus{
      outline:none;
      border-color:#667eea;
    }
    input::placeholder{color:#666}
    button{
      padding:14px 24px;
      cursor:pointer;
      border-radius:10px;
      border:none;
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:#fff;
      font-weight:600;
      transition:transform 0.2s, box-shadow 0.2s;
      box-shadow:0 4px 15px rgba(102, 126, 234, 0.3);
    }
    button:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(102, 126, 234, 0.4);
    }
    button:active{transform:translateY(0)}
    button:disabled{
      background:#333;
      cursor:not-allowed;
      opacity:0.5;
      transform:none;
      box-shadow:none;
    }
    .card{
      border:1px solid #262626;
      border-radius:16px;
      padding:20px;
      margin:20px 0;
      background:#1a1a1a;
      transition:transform 0.2s, box-shadow 0.2s;
    }
    .card:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 24px rgba(0,0,0,0.4);
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:16px;
      gap:12px;
      flex-wrap:wrap;
    }
    .card-info{
      flex:1;
      min-width:200px;
    }
    .card-title{
      font-size:15px;
      color:#e5e5e5;
      margin-bottom:6px;
      font-weight:500;
      line-height:1.4;
    }
    .card-url{
      font-size:11px;
      color:#8e8e8e;
      word-break:break-all;
    }
    .card-meta{
      font-size:11px;
      color:#666;
      margin-top:4px;
    }
    .video-container{
      position:relative;
      width:100%;
      max-width:500px;
      margin:16px auto;
      background:#000;
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 4px 20px rgba(0,0,0,0.5);
    }
    video{
      width:100%;
      display:block;
    }
    .loading{
      text-align:center;
      padding:60px 20px;
      color:#8e8e8e;
    }
    .loading::after{
      content:'';
      display:block;
      width:40px;
      height:40px;
      border:3px solid #333;
      border-top-color:#667eea;
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin:16px auto 0;
    }
    @keyframes spin{
      to{transform:rotate(360deg)}
    }
    .error{
      background:#2a1515;
      border:1px solid #4a1515;
      color:#ff6b6b;
      padding:14px;
      border-radius:10px;
      margin:12px 0;
      font-size:13px;
      line-height:1.5;
    }
    .msg{
      padding:12px 16px;
      border-radius:8px;
      margin-bottom:16px;
      font-size:14px;
      animation:slideIn 0.3s;
      min-height:20px;
    }
    .msg:empty{
      display:none;
    }
    @keyframes slideIn{
      from{opacity:0;transform:translateY(-10px)}
      to{opacity:1;transform:translateY(0)}
    }
    .msg.success{background:#1a3a1a;color:#5dd55d;border:1px solid #2a5a2a}
    .msg.error{background:#3a1a1a;color:#ff6b6b;border:1px solid #5a2a2a}
    .delete-btn{
      background:#262626;
      padding:8px 16px;
      font-size:13px;
      box-shadow:none;
    }
    .delete-btn:hover{
      background:#3a3a3a;
      transform:none;
    }
    h3{
      color:#e5e5e5;
      margin-top:40px;
      margin-bottom:20px;
      font-size:20px;
    }
    .empty{
      text-align:center;
      padding:60px 20px;
      color:#666;
      font-size:14px;
    }
    .platform-tag{
      display:inline-block;
      padding:4px 10px;
      border-radius:6px;
      font-size:11px;
      font-weight:700;
      margin-bottom:6px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .platform-tag.tiktok{background:#ff0050;color:#fff}
    .platform-tag.instagram{background:#e4405f;color:#fff}
    @media (max-width: 600px){
      .row{flex-direction:column}
      button{width:100%}
      .card-header{flex-direction:column}
      .delete-btn{width:100%}
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Video Viewer</h1>
    <p>Share TikTok and Instagram videos without needing accounts</p>
    <div class="status-badge">Shared database - Everyone sees the same videos</div>
  </div>
  
  <div class="row">
    <input id="url" placeholder="Paste TikTok or Instagram link here..." />
    <button id="add">Add Video</button>
  </div>
  <div id="msg"></div>

  <h3>Shared Videos</h3>
  <div id="list"></div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, push, onValue, remove, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCWKBocbyZWNT123KnCV2niqHItYSRXnhM",
      authDomain: "camusnologin.firebaseapp.com",
      databaseURL: "https://camusnologin-default-rtdb.firebaseio.com",
      projectId: "camusnologin",
      storageBucket: "camusnologin.firebasestorage.app",
      messagingSenderId: "774028315977",
      appId: "1:774028315977:web:e9e8e640cccf0358b99e98"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const videosRef = ref(database, 'videos');

    let isProcessing = false;
    let videosData = {};

    function showMsg(text, type='success'){
      const msg = document.getElementById('msg');
      msg.className = `msg ${type}`;
      msg.textContent = text;
      setTimeout(() => {
        msg.textContent = '';
        msg.className = 'msg';
      }, 4000);
    }

    function detectPlatform(url){
      if (/tiktok\.com/i.test(url) || /vt\.tiktok\.com/i.test(url)) return 'tiktok';
      if (/instagram\.com\/reel/i.test(url) || /instagram\.com\/p\//i.test(url)) return 'instagram';
      return 'unknown';
    }

    async function extractVideoTikTok(url){
      try {
        const response = await fetch('https://www.tikwm.com/api/', {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: `url=${encodeURIComponent(url)}`
        });
        const data = await response.json();
        
        if (data.code === 0 && data.data?.play) {
          return {
            videoUrl: data.data.play,
            title: data.data.title || 'TikTok Video',
            thumbnail: data.data.cover
          };
        }
        throw new Error('Could not extract video');
      } catch (e) {
        throw new Error('Error processing TikTok. Verify the link is correct.');
      }
    }

    async function extractVideoInstagram(url){
      try {
        const response = await fetch('https://api.snapinsta.app/api/convert', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({url: url})
        });
        const data = await response.json();
        
        if (data && data.url) {
          return {
            videoUrl: data.url,
            title: 'Instagram Reel',
            isEmbed: false
          };
        }
        throw new Error('Could not extract video');
      } catch (e) {
        const match = url.match(/(?:reel|p)\/([A-Za-z0-9_-]+)/);
        if (!match) throw new Error('Invalid Instagram URL');
        
        const postId = match[1];
        
        return {
          videoUrl: null,
          embedUrl: `https://www.instagram.com/p/${postId}/embed/`,
          title: 'Instagram Reel',
          isEmbed: true
        };
      }
    }

    async function getVideoData(url){
      const platform = detectPlatform(url);
      
      if (platform === 'tiktok') {
        return await extractVideoTikTok(url);
      } else if (platform === 'instagram') {
        return await extractVideoInstagram(url);
      } else {
        throw new Error('Platform not supported. Use TikTok or Instagram.');
      }
    }

    function createVideoCard(videoId, item){
      const card = document.createElement('div');
      card.className = 'card';

      const header = document.createElement('div');
      header.className = 'card-header';
      
      const infoDiv = document.createElement('div');
      infoDiv.className = 'card-info';
      
      const platform = detectPlatform(item.url);
      if (platform !== 'unknown') {
        const tag = document.createElement('span');
        tag.className = `platform-tag ${platform}`;
        tag.textContent = platform === 'tiktok' ? 'TikTok' : 'Instagram';
        infoDiv.appendChild(tag);
      }
      
      if (item.title) {
        const titleDiv = document.createElement('div');
        titleDiv.className = 'card-title';
        titleDiv.textContent = item.title;
        infoDiv.appendChild(titleDiv);
      }
      
      const urlDiv = document.createElement('div');
      urlDiv.className = 'card-url';
      urlDiv.textContent = item.url;
      infoDiv.appendChild(urlDiv);

      if (item.addedAt) {
        const metaDiv = document.createElement('div');
        metaDiv.className = 'card-meta';
        const date = new Date(item.addedAt);
        metaDiv.textContent = `Added ${date.toLocaleDateString()} at ${date.toLocaleTimeString()}`;
        infoDiv.appendChild(metaDiv);
      }
      
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-btn';
      deleteBtn.textContent = 'Delete';
      deleteBtn.onclick = async () => {
        try {
          await remove(ref(database, `videos/${videoId}`));
          showMsg('Video deleted');
        } catch (error) {
          showMsg('Error deleting video', 'error');
        }
      };

      header.appendChild(infoDiv);
      header.appendChild(deleteBtn);
      card.appendChild(header);

      if (item.error) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.innerHTML = `Error: ${item.error}<br><small>Make sure the video is public and the link is correct.</small>`;
        card.appendChild(errorDiv);
        
        const retryBtn = document.createElement('button');
        retryBtn.textContent = 'Retry';
        retryBtn.style.marginTop = '12px';
        retryBtn.onclick = async () => {
          try {
            const data = await getVideoData(item.url);
            await set(ref(database, `videos/${videoId}`), {
              url: item.url,
              ...data,
              addedAt: item.addedAt,
              error: null
            });
            showMsg('Video loaded successfully');
          } catch (err) {
            await set(ref(database, `videos/${videoId}/error`), err.message);
            showMsg('Error loading video', 'error');
          }
        };
        card.appendChild(retryBtn);
        
      } else if (item.isEmbed && item.embedUrl) {
        const container = document.createElement('div');
        container.className = 'video-container';
        container.style.height = '600px';
        
        const iframe = document.createElement('iframe');
        iframe.src = item.embedUrl;
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = 'none';
        iframe.allow = 'autoplay; encrypted-media';
        iframe.allowFullscreen = true;
        
        container.appendChild(iframe);
        card.appendChild(container);
        
        const openBtn = document.createElement('button');
        openBtn.textContent = 'Open in Instagram';
        openBtn.style.marginTop = '12px';
        openBtn.style.width = '100%';
        openBtn.onclick = () => window.open(item.url, '_blank');
        card.appendChild(openBtn);
        
      } else if (item.videoUrl) {
        const container = document.createElement('div');
        container.className = 'video-container';
        
        const video = document.createElement('video');
        video.src = item.videoUrl;
        video.controls = true;
        video.preload = 'metadata';
        video.loop = true;
        video.playsInline = true;
        container.appendChild(video);
        card.appendChild(container);
        
      } else if (!item.error) {
        const loading = document.createElement('div');
        loading.className = 'loading';
        loading.textContent = 'Loading video...';
        card.appendChild(loading);
      }

      return card;
    }

    function render(videos){
      const list = document.getElementById('list');
      list.innerHTML = '';

      if (!videos || Object.keys(videos).length === 0) {
        list.innerHTML = '<div class="empty">No videos shared yet. Add the first one!</div>';
        return;
      }

      // Convert to array and sort by date (newest first)
      const videosArray = Object.entries(videos).map(([id, data]) => ({id, ...data}));
      videosArray.sort((a, b) => (b.addedAt || 0) - (a.addedAt || 0));

      videosArray.forEach(item => {
        list.appendChild(createVideoCard(item.id, item));
      });
    }

    // Listen for real-time updates
    onValue(videosRef, (snapshot) => {
      const videos = snapshot.val();
      videosData = videos || {};
      render(videos);
    });

    document.getElementById('add').onclick = async () => {
      if (isProcessing) return;
      
      const urlInput = document.getElementById('url');
      const url = urlInput.value.trim();
      
      if (!url) {
        showMsg('Please paste a URL', 'error');
        return;
      }

      const platform = detectPlatform(url);
      if (platform === 'unknown') {
        showMsg('Invalid URL. Must be from TikTok or Instagram.', 'error');
        return;
      }

      // Check if video already exists
      const existing = Object.values(videosData).find(v => v.url === url);
      if (existing) {
        showMsg('This video is already in the list', 'error');
        return;
      }

      isProcessing = true;
      document.getElementById('add').disabled = true;
      urlInput.value = '';

      try {
        // Add placeholder to Firebase
        const newVideoRef = push(videosRef);
        await set(newVideoRef, {
          url,
          addedAt: Date.now(),
          videoUrl: null,
          error: null,
          title: null,
          isEmbed: false
        });

        // Extract video data
        try {
          const data = await getVideoData(url);
          await set(newVideoRef, {
            url,
            ...data,
            addedAt: Date.now(),
            error: null
          });
          showMsg('Video added successfully');
        } catch (err) {
          await set(ref(database, `${newVideoRef.key}/error`), err.message);
          showMsg('Error loading video', 'error');
        }
      } catch (error) {
        showMsg('Error adding video to database', 'error');
      } finally {
        isProcessing = false;
        document.getElementById('add').disabled = false;
      }
    };

    document.getElementById('url').onkeypress = (e) => {
      if (e.key === 'Enter' && !isProcessing) {
        document.getElementById('add').click();
      }
    };
  </script>
</body>
</html>
